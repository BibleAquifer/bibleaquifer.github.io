# Building the Static Site

This document explains how to build the BibleAquifer static site from source.

## Overview

The site is now generated statically using a Python script (`src/build_site.py`) that:
1. Fetches the organization README from `.github` repository
2. Queries the GitHub API to discover all resources
3. Fetches metadata.json for each language in each resource
4. Generates `index.html` with embedded README content
5. Generates `catalog.html` with pre-populated resource data

## Prerequisites

- Python 3.9 or higher
- Poetry (Python package manager)
- GitHub API access (optional but recommended to avoid rate limits)

## Installation

1. Install Poetry if not already installed:
   ```bash
   pip install poetry
   ```

2. Install project dependencies:
   ```bash
   poetry install
   ```

## Building the Site

### Required GitHub Token

The build script requires a GitHub API token to fetch repository data. The script looks for tokens in this order:
1. `manage-aquifer` environment variable
2. `GITHUB_AQUIFER_API_KEY` environment variable

If neither token is found, the script will exit with an error.

```bash
# Using manage-aquifer token
export manage-aquifer=your_token_here
poetry run python src/build_site.py

# OR using GITHUB_AQUIFER_API_KEY token
export GITHUB_AQUIFER_API_KEY=your_token_here
poetry run python src/build_site.py
```

The script will:
- Generate `index.html`
- Generate `catalog.html`
- Create `resources_data.yaml` (for reference, not used by the site)

### Testing the Build Script (Debug Mode)

To test the build script with sample data (doesn't require GitHub API access):

```bash
DEBUG_MODE=true poetry run python src/build_site.py
```

Or use the sample data generator:

```bash
poetry run python src/generate_sample.py
```

Or run the test suite:

```bash
poetry run python src/test_build.py
```

This will create test files: `src/test_index.html`, `src/test_catalog.html`, and `src/test_resources.yaml`.

## Output Files

After running the build script:

- `index.html` - Landing page with embedded organization README
- `catalog.html` - Catalog page with embedded resource metadata
- `resources_data.yaml` - YAML representation of all resource data (for reference)

## How It Works

### index.html

The `index.html` file is generated by:
1. Fetching the README from `BibleAquifer/.github/profile/README.md`
2. Converting the Markdown to HTML
3. Wrapping sections in `content-section` divs
4. Embedding the HTML in the page template

No JavaScript is required for the index page - it's completely static.

### catalog.html

The `catalog.html` file is generated by:
1. Fetching all repositories from the BibleAquifer organization
2. For each repository, discovering available language directories (3-letter codes)
3. Fetching `metadata.json` for each language
4. Extracting resource titles from `resource_metadata.title` or `resource_metadata.license_info.title`
5. Checking for the existence of `pdf` and `docx` directories
6. Embedding all data as JSON in the HTML file

The catalog page uses vanilla JavaScript to:
- Populate dropdowns from embedded data
- Display resource information when selections change
- Show download links for available formats

### Resource Titles

Resources are displayed in the catalog using their proper titles from metadata.json instead of repository names:
- Repository: `UWTranslationNotes`
- Display Title: `Translation Notes (unfoldingWord)`

## Development Workflow

1. Make changes to `src/build_site.py` or templates
2. Test with `poetry run python src/test_build.py`
3. Build the site with `poetry run python src/build_site.py`
4. Test locally with a web server: `python3 -m http.server 8080`
5. Commit the generated HTML files

## Deployment

The generated `index.html` and `catalog.html` files should be committed to the repository. GitHub Pages will automatically serve them.

## Scheduling Rebuilds

To keep the catalog up to date with new resources:
- Set up a GitHub Actions workflow to run the build script periodically
- The workflow should commit and push changes when new resources are detected

Example workflow (to be implemented in a future issue):
```yaml
name: Rebuild Site
on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - run: pip install poetry
      - run: poetry install
      - run: poetry run python src/build_site.py
        env:
          manage-aquifer: ${{ secrets.MANAGE_AQUIFER_TOKEN }}
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Rebuild site with latest data"
```

## Troubleshooting

### GitHub API Rate Limit

If you see "403 Forbidden" errors:
- You've hit the GitHub API rate limit
- Ensure you have set the `manage-aquifer` or `GITHUB_AQUIFER_API_KEY` environment variable
- Wait for the rate limit to reset (check headers in error message)

### Missing Token

If you see "ERROR: Required GitHub token not found":
- Set the `manage-aquifer` environment variable with your GitHub token
- OR set the `GITHUB_AQUIFER_API_KEY` environment variable
- OR run with `DEBUG_MODE=true` to use test data

### Missing Resources

If resources don't appear in the catalog:
- Ensure the repository is not in the EXCLUDED_REPOS list
- Verify the repository has language directories (3-letter codes)
- Check that `metadata.json` exists in language directories and contains `resource_metadata/title`
- Review console output for errors during the build

### Dependencies

If you get import errors:
```bash
poetry install
```

## Files

- `src/build_site.py` - Main build script
- `src/generate_sample.py` - Generate site with sample data
- `src/test_build.py` - Test script with sample data
- `pyproject.toml` - Poetry configuration and dependencies
- `.gitignore` - Excludes Python artifacts and generated YAML
